<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Basis constructor for a dimer &#8212; Learn DMFT 0.5.0-git documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.5.0-git',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Learn DMFT 0.5.0-git documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="basis-constructor-for-a-dimer">
<span id="sphx-glr-dimer-lattice-cthyb-link-py"></span><h1>Basis constructor for a dimer<a class="headerlink" href="#basis-constructor-for-a-dimer" title="Permalink to this headline">Â¶</a></h1>
<p>Generates cix file</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">linalg</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">optparse</span>


<span class="k">def</span> <span class="nf">union</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">):</span>
    <span class="s2">&quot; Takes a union of two lists&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">data1</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">funique</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">ndata</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ndata</span><span class="p">:</span>
            <span class="n">ndata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ndata</span>


<span class="k">class</span> <span class="nc">compare</span><span class="p">:</span>
    <span class="s2">&quot;Compares two-site states in the basis&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseNKS</span> <span class="o">=</span> <span class="n">baseNKS</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>  <span class="c1"># special function</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseNKS</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseNKS</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">wdot</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">stb</span><span class="p">):</span>
    <span class="n">dsum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sta</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stb</span><span class="p">)):</span>
            <span class="c1"># print &#39;sta,stb=&#39;, sta[i][0], stb[j][0]</span>
            <span class="k">if</span> <span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">stb</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">dsum</span> <span class="o">+=</span> <span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">stb</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># if abs(dsum)&gt;0:</span>
    <span class="c1">#    print &#39;dsum=&#39;, dsum, &#39;sta0=&#39;, sta, &#39;sbt0=&#39;, stb</span>
    <span class="k">return</span> <span class="n">dsum</span>


<span class="k">def</span> <span class="nf">wdot0</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">wsmall</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sta</span><span class="p">)):</span>
        <span class="n">new_candidates</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">new_candidates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="n">wprod</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">wdot</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">base</span><span class="p">[</span><span class="n">candidate</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">wsmall</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">wprod</span><span class="p">:</span>
                <span class="n">wprod</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span> <span class="o">+=</span> <span class="n">w</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wprod</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>

    <span class="k">return</span> <span class="n">wprod</span>


<span class="k">def</span> <span class="nf">ReadOneSiteCix</span><span class="p">(</span><span class="n">fcix</span><span class="p">):</span>
    <span class="s2">&quot;Reading cix file for one site DMFT&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fcix</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">s0</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># CIX file for ctqmc!</span>
    <span class="c1"># cluster_size, number of states, number of baths, maximum_matrix_size</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="p">(</span><span class="n">Nc0</span><span class="p">,</span> <span class="n">Ns0</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Nm0</span><span class="p">)</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">Nc0</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Wrong cix file. Input cix should be for single site!&#39;</span><span class="p">)</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># baths, dimension, symmetry</span>
    <span class="n">baths</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">Nb0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
        <span class="p">(</span><span class="n">iib</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">ibg</span><span class="p">)</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">iib</span> <span class="o">!=</span> <span class="n">ib</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Something wrong reading cix file (1)!&#39;</span><span class="p">)</span>
        <span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">ibg</span><span class="p">)</span>
    <span class="c1"># print baths</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># cluster energies for non-equivalent baths, eps[k]</span>
    <span class="n">Nunique</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">baths</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
    <span class="c1"># print eps</span>
    <span class="n">s4</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># N   K   Sz size</span>

    <span class="n">mN</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">Ns0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">mSz</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">Ns0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">msize</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">Ns0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">Fi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">Ns0</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">mEne</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">Ns0</span><span class="p">,</span> <span class="n">Nm0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">mS2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">Ns0</span><span class="p">,</span> <span class="n">Nm0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns0</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ii</span> <span class="o">!=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Something wrong reading cix file (2)!&#39;</span><span class="p">)</span>
        <span class="n">mN</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mSz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">msize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
            <span class="n">Fi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span> <span class="o">+</span> <span class="n">ib</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">msize</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">mEne</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span> <span class="o">+</span> <span class="n">Nb0</span> <span class="o">+</span> <span class="n">j</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">msize</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">mS2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span> <span class="o">+</span> <span class="n">Nb0</span> <span class="o">+</span> <span class="n">msize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span><span class="p">])</span>

    <span class="n">s5</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># matrix elements</span>

    <span class="n">Fm</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns0</span><span class="p">):</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
            <span class="n">fm</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">Fm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ii</span> <span class="o">!=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Something wrong reading cix file (3)!&#39;</span><span class="p">)</span>
            <span class="n">ij</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ij</span> <span class="o">!=</span> <span class="n">Fi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Something wrong reading cix file (4)!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ij</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sizei</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">sizej</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">sizei</span> <span class="o">!=</span> <span class="n">msize</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Something wrong reading cix file (5)!&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sizej</span> <span class="o">!=</span> <span class="n">msize</span><span class="p">[</span><span class="n">ij</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Something wrong reading cix file (6)!&#39;</span><span class="p">)</span>
                <span class="n">fm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">sizei</span><span class="p">,</span> <span class="n">sizej</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">cii</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">im1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sizei</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">im2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sizej</span><span class="p">):</span>
                        <span class="n">fm</span><span class="p">[</span><span class="n">im1</span><span class="p">,</span> <span class="n">im2</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">cii</span><span class="p">]</span>
                        <span class="n">cii</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">Fm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ib</span><span class="p">]</span> <span class="o">=</span> <span class="n">fm</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">Nc0</span><span class="p">,</span> <span class="n">Ns0</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Nm0</span><span class="p">,</span> <span class="n">baths</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">mN</span><span class="p">,</span> <span class="n">mSz</span><span class="p">,</span> <span class="n">msize</span><span class="p">,</span> <span class="n">mEne</span><span class="p">,</span> <span class="n">mS2</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Fm</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">RemoveBaths</span><span class="p">(</span><span class="n">Nb0</span><span class="p">,</span> <span class="n">Ns0</span><span class="p">,</span> <span class="n">baths</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">Ek</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Fm</span><span class="p">,</span> <span class="n">PRINT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;###########################################</span>
<span class="sd">       # removing baths which have energy &gt; 1000 #</span>
<span class="sd">       ###########################################</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bkeep</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ib</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">baths</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">eps</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">&lt;</span> <span class="mf">1000.</span><span class="p">:</span>
            <span class="n">bkeep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;baths= &#39;</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">eps</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

    <span class="n">n_Nb0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bkeep</span><span class="p">)</span>
    <span class="n">n_baths</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">n_Nb0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bkeep</span><span class="p">):</span>
        <span class="n">n_baths</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">n_baths</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_baths</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">n_baths</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_baths</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>

    <span class="n">n_Nunique</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n_baths</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">n_eps</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">n_Nunique</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">n_Ek</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">n_Nb0</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bkeep</span><span class="p">):</span>
        <span class="n">n_eps</span><span class="p">[</span><span class="n">n_baths</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">eps</span><span class="p">[</span><span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        <span class="c1">#n_Ek[i] = Ek[ib]</span>
        <span class="c1">#n_Ek[i+n_Nb0] = Ek[ib+Nb0]</span>
        <span class="n">n_Ek</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ek</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ib</span><span class="p">]</span>
        <span class="n">n_Ek</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ek</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ib</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">n_Fi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">Ns0</span><span class="p">,</span> <span class="n">n_Nb0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">n_Fm</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns0</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ib</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bkeep</span><span class="p">):</span>
            <span class="n">n_Fi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>
            <span class="n">n_Fm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Fm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">b</span><span class="p">])</span>

    <span class="c1">#Nb0 = n_Nb0</span>
    <span class="c1">#baths = n_baths</span>
    <span class="c1">#Nunique = n_Nunique</span>
    <span class="c1">#eps = n_eps</span>
    <span class="c1">#Fi = n_Fi</span>
    <span class="c1">#Fm = n_Fm</span>
    <span class="c1">#Ek = n_Ek</span>

    <span class="k">if</span> <span class="n">PRINT</span><span class="p">:</span>
        <span class="k">print</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;baths=&#39;</span><span class="p">,</span> <span class="n">n_baths</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Nunique=&#39;</span><span class="p">,</span> <span class="n">n_Nunique</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;eps=&#39;</span><span class="p">,</span> <span class="n">n_eps</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Ek=&#39;</span><span class="p">,</span> <span class="n">n_Ek</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">n_Nb0</span><span class="p">,</span> <span class="n">n_baths</span><span class="p">,</span> <span class="n">n_eps</span><span class="p">,</span> <span class="n">n_Ek</span><span class="p">,</span> <span class="n">n_Fi</span><span class="p">,</span> <span class="n">n_Fm</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">CorrectSingleSiteEnergies</span><span class="p">(</span><span class="n">Ns0</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">msize</span><span class="p">,</span> <span class="n">mN</span><span class="p">,</span> <span class="n">mEne</span><span class="p">,</span> <span class="n">baths</span><span class="p">,</span> <span class="n">Uc</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">Ek</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Fm</span><span class="p">,</span> <span class="n">PRINT</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adds Coulomb-U to one site energies.</span>
<span class="sd">        Creates energies for the two site problem.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Ek_local</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ek</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ib</span><span class="p">]</span> <span class="o">+</span> <span class="n">Ek</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ib</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">)]</span>  <span class="c1"># from input Ek</span>
    <span class="n">Ek_local_orig</span> <span class="o">=</span> <span class="p">[</span><span class="n">eps</span><span class="p">[</span><span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                     <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">)]</span>  <span class="c1"># from origonal SS-cix file</span>
    <span class="c1"># Adding Coulomb U!</span>
    <span class="n">mE</span> <span class="o">=</span> <span class="p">[</span><span class="n">mEne</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Uc</span> <span class="o">*</span> <span class="n">mN</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mN</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mEne</span><span class="p">))]</span>

    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>  <span class="c1"># Correcting single-particle energies</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns0</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns0</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">Fi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">msize</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">im1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">msize</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">im2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">msize</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                        <span class="n">r</span><span class="p">[</span><span class="n">im2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Fm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">im1</span><span class="p">,</span> <span class="n">im2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">R</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)):</span>
            <span class="n">mE</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ek_local</span><span class="p">[</span><span class="n">ib</span><span class="p">]</span> <span class="o">-</span> <span class="n">Ek_local_orig</span><span class="p">[</span><span class="n">ib</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">mE</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Create2SiteBasis</span><span class="p">(</span><span class="n">Ns0</span><span class="p">,</span> <span class="n">mN</span><span class="p">,</span> <span class="n">mSz</span><span class="p">,</span> <span class="n">mEne</span><span class="p">,</span> <span class="n">PRINT</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Creates a basis for the two site problem from the basis of a one-site problem.</span>
<span class="sd">           --  base[int]=[ [(i1,i2),coeff1], [(i3,i4),coeff2],... ]</span>
<span class="sd">                 is a basis constructed as a direct product of one-site states,</span>
<span class="sd">                 but in bonding--anti-bonding representation, such that momentum is a good</span>
<span class="sd">                 quantum number (only (0,..), and (pi,...)</span>

<span class="sd">                 Quantum mechanically, we would write</span>
<span class="sd">                    base[int] = coeff1*|i1&gt;x|i2&gt; + coeff2|i2&gt;x|i3&gt;+...</span>

<span class="sd">                 Here (i1,i2) is a tuple of pointers to one-site basis, i.e., i1 is index in the one-site basis.</span>
<span class="sd">                 Coeff1 is the prefactor for the direct product.</span>

<span class="sd">           --  baseNKS[int] = [N, K, Sz, Energy]</span>
<span class="sd">                 Here Energy contains only the on-site part, but not the hopping part.</span>
<span class="sd">                 The hopping part is added later after exact diagonalization.</span>

<span class="sd">        It also creates an index pointer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sq2</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">baseNKS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns0</span><span class="p">):</span>
        <span class="c1"># for i2 in range(i1,Ns0):</span>
        <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i1</span> <span class="o">!=</span> <span class="n">i2</span><span class="p">:</span>
                <span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">mN</span><span class="p">[</span><span class="n">i1</span><span class="p">],</span> <span class="n">mN</span><span class="p">[</span><span class="n">i2</span><span class="p">])</span>
                <span class="p">(</span><span class="n">sz1</span><span class="p">,</span> <span class="n">sz2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">mSz</span><span class="p">[</span><span class="n">i1</span><span class="p">],</span> <span class="n">mSz</span><span class="p">[</span><span class="n">i2</span><span class="p">])</span>
                <span class="c1"># K=0</span>
                <span class="n">Ene</span> <span class="o">=</span> <span class="n">mEne</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">mEne</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">base</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[[(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">),</span> <span class="n">sq2</span><span class="p">],</span> <span class="p">[(</span><span class="n">i2</span><span class="p">,</span> <span class="n">i1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sq2</span><span class="p">]])</span>
                <span class="n">baseNKS</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sz1</span> <span class="o">+</span> <span class="n">sz2</span><span class="p">,</span> <span class="n">Ene</span><span class="p">])</span>
                <span class="c1"># K=Pi</span>
                <span class="n">Ene</span> <span class="o">=</span> <span class="n">mEne</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">mEne</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">base</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[[(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">),</span> <span class="n">sq2</span><span class="p">],</span> <span class="p">[(</span><span class="n">i2</span><span class="p">,</span> <span class="n">i1</span><span class="p">),</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sq2</span><span class="p">]])</span>
                <span class="n">baseNKS</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sz1</span> <span class="o">+</span> <span class="n">sz2</span><span class="p">,</span> <span class="n">Ene</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base</span><span class="o">.</span><span class="n">append</span><span class="p">([[(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i1</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">]])</span>
                <span class="n">baseNKS</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">mN</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mSz</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mEne</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">])</span>

    <span class="c1"># index for sorting the base</span>
    <span class="n">indbase</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)))</span>
    <span class="c1"># creates cmp function by class compare</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">compare</span><span class="p">(</span><span class="n">baseNKS</span><span class="p">)</span>
    <span class="c1"># sorts base</span>
    <span class="n">indbase</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">cmp</span><span class="o">=</span><span class="n">comp</span><span class="p">)</span>
    <span class="n">wbase</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">wbaseNKS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
        <span class="n">wbase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="n">indbase</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span>
        <span class="n">wbaseNKS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">baseNKS</span><span class="p">[</span><span class="n">indbase</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">wbase</span>
    <span class="n">baseNKS</span> <span class="o">=</span> <span class="n">wbaseNKS</span>

    <span class="c1"># Index pointer from two-site base to two one-site bases.</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns0</span><span class="p">):</span>
            <span class="n">pairs</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">pairs</span><span class="p">[</span><span class="n">base</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">PRINT</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;base=&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">base</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">,</span> <span class="n">pairs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ComputeFdag</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">mN</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Fm</span><span class="p">,</span> <span class="n">PRINT</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">sq2</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
    <span class="c1"># Creating F^dagger in this new even-odd basis</span>
    <span class="n">Fp_K</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># print &#39;st=&#39;, st</span>
        <span class="n">fmn1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
            <span class="n">fmn0</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="c1"># print &#39;st=&#39;, st # starting with this state</span>
                <span class="n">Fst</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)):</span>
                    <span class="c1"># composed of st1 at site 1 and st2 at site 2</span>
                    <span class="p">(</span><span class="n">st1</span><span class="p">,</span> <span class="n">st2</span><span class="p">)</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">n1</span> <span class="o">=</span> <span class="n">mN</span><span class="p">[</span><span class="n">st1</span><span class="p">]</span>          <span class="c1"># number of electrons on site 1</span>
                    <span class="k">if</span> <span class="n">Fi</span><span class="p">[</span><span class="n">st1</span><span class="p">,</span> <span class="n">ib</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>      <span class="c1"># adding electron at site 1</span>
                        <span class="c1"># The starting state is a product state of |n_1&gt; at site 1 and state |n_2&gt; at site 2.</span>
                        <span class="c1"># psi^+_k |n_1&gt; x |n_2&gt; = 1/sqrt(2)[ (psi^+_1|n_1&gt;) x</span>
                        <span class="c1"># |n_2&gt; + e^{ik} |n_1&gt; x (psi^+_2|n_2&gt; x |n_2&gt; )]</span>
                        <span class="n">Fst</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">Fi</span><span class="p">[</span><span class="n">st1</span><span class="p">,</span> <span class="n">ib</span><span class="p">],</span> <span class="n">st2</span><span class="p">),</span> <span class="n">st</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="o">*</span> <span class="n">sq2</span> <span class="o">*</span> <span class="n">Fm</span><span class="p">[</span><span class="n">st1</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="n">Fi</span><span class="p">[</span><span class="n">st2</span><span class="p">,</span> <span class="n">ib</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>      <span class="c1"># adding electron at site 2</span>
                        <span class="n">Fst</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">st1</span><span class="p">,</span> <span class="n">Fi</span><span class="p">[</span><span class="n">st2</span><span class="p">,</span> <span class="n">ib</span><span class="p">]),</span> <span class="n">st</span><span class="p">[</span><span class="n">a</span><span class="p">][</span>
                                   <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sq2</span> <span class="o">*</span> <span class="n">Fm</span><span class="p">[</span><span class="n">st2</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">n1</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">ik</span><span class="p">])</span>

                <span class="n">wprod</span> <span class="o">=</span> <span class="n">wdot0</span><span class="p">(</span><span class="n">Fst</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">pairs</span><span class="p">)</span>

                <span class="n">fmn0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wprod</span><span class="p">)</span>
                <span class="c1"># print &#39;prodct=&#39;, i, ib, ik, wprod, Fst</span>

            <span class="n">fmn1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmn0</span><span class="p">)</span>
        <span class="n">Fp_K</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmn1</span><span class="p">)</span>

    <span class="c1"># Creating F from F^dagger</span>
    <span class="n">Fm_K</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">f1</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
            <span class="n">f2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
        <span class="n">Fm_K</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="n">Fp_K</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">Fm_K</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">PRINT</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;F^\dagger=&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">Fp_K</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;F = &#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">Fm_K</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">Fp_K</span><span class="p">,</span> <span class="n">Fm_K</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ComputeOccup</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Fp_K</span><span class="p">,</span> <span class="n">Fm_K</span><span class="p">,</span> <span class="n">TEST</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Here we compute all_NN = F^dagger*F</span>
<span class="sd">       We also compute F*F^dagger, and we can check if F^dagger*F+F*F^dagger=1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_NN</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
        <span class="n">NN2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
            <span class="n">NN1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="c1"># Here we compute F^dagger * F</span>
                <span class="n">NN</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">fm</span> <span class="o">=</span> <span class="n">Fm_K</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">fpfm</span> <span class="o">=</span> <span class="n">Fp_K</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">fpfm</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">NN</span><span class="p">:</span>
                            <span class="n">NN</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fpfm</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">*</span> <span class="n">fm</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">NN</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpfm</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">*</span> <span class="n">fm</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="n">NN1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NN</span><span class="p">)</span>
                <span class="c1"># Here we compute F * F^dagger</span>
                <span class="n">MM</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="n">Fp_K</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">fmfp</span> <span class="o">=</span> <span class="n">Fm_K</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">fmfp</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">MM</span><span class="p">:</span>
                            <span class="n">MM</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fmfp</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">*</span> <span class="n">fp</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">MM</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmfp</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">*</span> <span class="n">fp</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>

                <span class="c1"># Here we merge F^dagger * F + F * F^dagger and check identity</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">TEST</span><span class="p">):</span>
                    <span class="n">akeys</span> <span class="o">=</span> <span class="n">union</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">NN</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;##i=&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;akeys=&#39;</span><span class="p">,</span> <span class="n">akeys</span><span class="p">)</span>  <span class="c1"># ?????</span>
                    <span class="n">canticom</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">akeys</span><span class="p">:</span>
                        <span class="n">cc</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">NN</span><span class="p">:</span>
                            <span class="n">cc</span> <span class="o">+=</span> <span class="n">NN</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">MM</span><span class="p">:</span>
                            <span class="n">cc</span> <span class="o">+=</span> <span class="n">MM</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>
                            <span class="n">canticom</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;f^+f+ff^+&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">canticom</span><span class="p">)</span>
            <span class="n">NN2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NN1</span><span class="p">)</span>
        <span class="n">all_NN</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NN2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_NN</span>


<span class="k">def</span> <span class="nf">CreateDiagPseudos</span><span class="p">(</span><span class="n">Nb0</span><span class="p">,</span> <span class="n">Fp_K</span><span class="p">,</span> <span class="n">all_NN</span><span class="p">,</span> <span class="n">Ek</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">,</span> <span class="n">wsmall</span><span class="p">,</span> <span class="n">PRINT</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Here we first apply F^+_K to empty state, to generate all atomic states with</span>
<span class="sd">        occupancy unity. We than apply F^+_K to those with occupancy 1 and create</span>
<span class="sd">        all with occupancy 2, etc.</span>
<span class="sd">        This creates blocks of superstates: pseudo[i] = [[i0],[i1,i2], [i3,i4],...]</span>
<span class="sd">        which contains groups of states, such as two dimensional superstate [i1,i2].</span>
<span class="sd">        Such state [i1,i2] or [i3,i4] are current superstates.</span>

<span class="sd">        We than create indexes to these superstates. We show example of a one band model,</span>
<span class="sd">        where a link contains 16 states.</span>

<span class="sd">        In this case, pseudo contains the following data:</span>
<span class="sd">        [[0],[1],[2],[3],[4],[5],[6,9],[7,10],[8],[11],[12],[13],[14],[15]]</span>

<span class="sd">        and index table contains:</span>
<span class="sd">        blci1[0]=[0]</span>
<span class="sd">        ....</span>
<span class="sd">        blci1[6]=[6,9]</span>
<span class="sd">        blci1[7]=[7,10]</span>
<span class="sd">        blci1[8]=[8]</span>
<span class="sd">        blci1[9]=[11]</span>
<span class="sd">        blci1[10]=[12]</span>
<span class="sd">        blci1[11]=[13]</span>
<span class="sd">        blci1[12]=[14]</span>
<span class="sd">        blci1[13]=[15]</span>

<span class="sd">        and its inverse:</span>
<span class="sd">        blci[0]=0</span>
<span class="sd">        blci[1]=1</span>
<span class="sd">        blci[2]=2</span>
<span class="sd">        blci[3]=3</span>
<span class="sd">        blci[4]=4</span>
<span class="sd">        blci[5]=5</span>
<span class="sd">        blci[6]=6</span>
<span class="sd">        blci[7]=7</span>
<span class="sd">        blci[8]=8</span>
<span class="sd">        blci[9]=6</span>
<span class="sd">        blci[10]=7</span>
<span class="sd">        blci[11]=9</span>
<span class="sd">        blci[12]=10</span>
<span class="sd">        blci[13]=11</span>
<span class="sd">        blci[14]=12</span>
<span class="sd">        blci[15]=13</span>

<span class="sd">        Next we create Hamiltonian, using the on-site terms baseNKS[:][3] and hopping.</span>
<span class="sd">        The latter is approximated by intra-orbital terms only (within the same orbital).</span>
<span class="sd">        In this case, hopping is block diagonal in the basis of superstates, and it takes the form:</span>
<span class="sd">        Hopp[ip,jp]=(F^+_{b,K} F_{b,K})_{ip,jp}*Ek[K,b]</span>

<span class="sd">        This is because a superstate contains all terms that can be reached with operator</span>
<span class="sd">                &lt;m,i|F_{b,K}^+ F_{b,K}|m,j&gt;</span>

<span class="sd">        Finally, we diagonalize the two-site Hamiltonian.</span>
<span class="sd">        For convenience, we make sure the largest component of the eigenvector is positive (add minus sign if needed).</span>



<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Ek_hop</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ek</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
        <span class="n">Ek_local</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ek</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ib</span><span class="p">]</span> <span class="o">+</span> <span class="n">Ek</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ib</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">Ek_hop</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ib</span> <span class="o">+</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ek</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ib</span> <span class="o">+</span> <span class="n">ik</span><span class="p">]</span> <span class="o">-</span> <span class="n">Ek_local</span>

    <span class="n">blc_ind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">blci</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">blci1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
    <span class="n">pseudo</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">Tr</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">]])}</span>
    <span class="n">Eham</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]}</span>
    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Nb0</span><span class="p">):</span>
        <span class="n">pseudon</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pseudo_old</span> <span class="o">=</span> <span class="n">pseudo</span><span class="p">[:]</span>
        <span class="c1"># Here we start with all states at valence N-1, and from them we generate</span>
        <span class="c1"># states with valence N. We generate by applying F_k^+ to state at N-1.</span>
        <span class="k">for</span> <span class="n">pse</span> <span class="ow">in</span> <span class="n">pseudo</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">block</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pse</span><span class="p">:</span>
                        <span class="n">nblck</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Fp_K</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="c1"># Instead of block += nblck</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nblck</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
                                <span class="n">block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">block</span><span class="p">:</span>

                        <span class="c1"># block.sort()</span>
                        <span class="c1">#if block not in pseudon: pseudon.append(block)</span>

                        <span class="c1"># create a set such that we can take union and</span>
                        <span class="c1"># intersection.</span>
                        <span class="n">block</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                        <span class="n">saved</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudon</span><span class="p">:</span>  <span class="c1"># over all current superstates at this occupancy</span>
                            <span class="k">if</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="n">block</span><span class="p">:</span>  <span class="c1"># does this superstate contain parts of the block</span>
                                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">|</span> <span class="n">block</span>  <span class="c1"># than we need to take a union</span>
                                <span class="n">saved</span> <span class="o">=</span> <span class="bp">True</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">saved</span><span class="p">:</span>     <span class="c1"># if it is entirely different superstate</span>
                            <span class="c1"># we just save it in entirety</span>
                            <span class="n">pseudon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

        <span class="c1">#pseudo = sorted(pseudon)</span>
        <span class="n">pseudo</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudon</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pseudo</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># diagonalizing hopping term</span>
        <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">pseudo</span><span class="p">:</span>
            <span class="c1"># first create index tp later update Fp</span>
            <span class="n">blc_ind</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">blci1</span><span class="p">[</span><span class="n">blc_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">:</span>
                <span class="n">blci</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">blc_ind</span>

            <span class="c1"># Hopping part of the Hamiltonian</span>
            <span class="n">hamilt</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ps</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ps</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ps</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">jp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ps</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">jp</span> <span class="ow">in</span> <span class="n">all_NN</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">]:</span>
                                <span class="n">hamilt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">all_NN</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">jp</span><span class="p">]</span> <span class="o">*</span> \
                                    <span class="n">Ek_hop</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ib</span> <span class="o">+</span> <span class="n">ik</span><span class="p">]</span>
            <span class="c1"># Potential part of the Hamiltonian</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ps</span><span class="p">):</span>
                <span class="c1"># For now only one dimensional states are treeted????</span>
                <span class="n">hamilt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">baseNKS</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">ee</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/scipy-0.15.1/reference/generated/scipy.linalg.eigh.html#scipy.linalg.eigh" title="View documentation for scipy.linalg.eigh"><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span></a><span class="p">(</span><span class="n">hamilt</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">PRINT</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Hamilt=&#39;</span><span class="p">,</span> <span class="n">hamilt</span><span class="p">,</span> <span class="s1">&#39;diag=&#39;</span><span class="p">,</span> <span class="n">ee</span><span class="p">)</span>

            <span class="c1"># Here we add a phase factor to eigenvectors, such that the largest component</span>
            <span class="c1"># of the eigenvector is positive.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ps</span><span class="p">)):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">ee</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">max_val</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.</span>

            <span class="n">Tr</span><span class="p">[</span><span class="n">blc_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ee</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Eham</span><span class="p">[</span><span class="n">blc_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ee</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Here we check if there is any degeneracy left. In this case we might be able to choose</span>
            <span class="c1"># eigenvectors more efficiently!!!!</span>
            <span class="n">degene</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ee</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">degen</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ee</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ee</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ee</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">wsmall</span><span class="p">:</span>
                        <span class="n">degen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                        <span class="c1"># print &#39;WARNING: degeneracy&#39;</span>
                        <span class="c1"># print &#39;rs=&#39;, ps, ee[0] #, hop #,</span>
                        <span class="c1"># matrix(Tr[blc_ind]).T*matrix(hop)*matrix(Tr[blc_ind])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">degen</span><span class="p">:</span>
                    <span class="n">degene</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">degen</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
            <span class="k">if</span> <span class="n">degene</span><span class="p">:</span>
                <span class="c1"># print &#39;degen=&#39;, ps, degene, ee[0]</span>
                <span class="k">for</span> <span class="n">degen</span> <span class="ow">in</span> <span class="n">degene</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">degen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">v0</span> <span class="o">=</span> <span class="n">ee</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">degen</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">ee</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">degen</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="n">vs0</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">+</span> <span class="n">v1</span><span class="p">)</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
                        <span class="n">vs1</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">-</span> <span class="n">v1</span><span class="p">)</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
                        <span class="n">e0</span> <span class="o">=</span> <span class="n">ee</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">degen</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">e1</span> <span class="o">=</span> <span class="n">ee</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">degen</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

                        <span class="c1"># Maybe I should not do that!</span>
                        <span class="c1"># ee[1][degen[0]]=vs0</span>
                        <span class="c1"># ee[1][degen[1]]=vs1</span>

                        <span class="c1"># print &#39;v0=&#39;, v0, &#39;E0=&#39;, e0</span>
                        <span class="c1"># print &#39;v1=&#39;, v1, &#39;E1=&#39;, e1</span>
                        <span class="c1"># print &#39;v0=&#39;, vs0, &#39;E0=&#39;, e0</span>
                        <span class="c1"># print &#39;v1=&#39;, vs1, &#39;E1=&#39;, e1</span>
                        <span class="c1"># Tr[blc_ind]=ee[1]</span>
                        <span class="c1"># Eham[blc_ind]=ee[0]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">PRINT</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">Fp_K</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">PRINT</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;blci1=&#39;</span><span class="p">,</span> <span class="n">blci1</span><span class="p">)</span>

    <span class="c1"># Finally, writing Energy in more convenient form for later printing</span>
    <span class="n">Energy</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">EVector</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">blci1</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blci1</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
            <span class="n">Energy</span><span class="p">[</span><span class="n">j1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Eham</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i1</span><span class="p">]</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="n">j2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blci1</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                <span class="n">vec</span><span class="p">[</span><span class="n">j2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tr</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i2</span><span class="p">,</span> <span class="n">i1</span><span class="p">]</span>
            <span class="n">EVector</span><span class="p">[</span><span class="n">j1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>
    <span class="k">if</span> <span class="n">PRINT</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Energy[&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;]=&#39;</span><span class="p">,</span> <span class="n">Energy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                  <span class="s1">&#39;EVector[&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;]=&#39;</span><span class="p">,</span> <span class="n">EVector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">pseudo</span><span class="p">,</span> <span class="n">blci</span><span class="p">,</span> <span class="n">blci1</span><span class="p">,</span> <span class="n">Tr</span><span class="p">,</span> <span class="n">Eham</span><span class="p">,</span> <span class="n">Energy</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Transform_F_To_Eigensybase</span><span class="p">(</span><span class="n">Fp_K</span><span class="p">,</span> <span class="n">Tr</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">blci</span><span class="p">,</span> <span class="n">blci1</span><span class="p">,</span> <span class="n">wsmall</span><span class="p">,</span> <span class="n">PRINT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;On the input, the matrix elements of creation operator are written in original two-site</span>
<span class="sd">       basis, but not yet in the eigenbasis.</span>
<span class="sd">       We computed the eigenbasis in &quot;CreateDiagPseudos&quot;, but did not yet transform F.</span>
<span class="sd">       Here we do the transformation, and return F written in the eigenbasis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Fp_Knew</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
        <span class="n">fpKn2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">fpKn1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
                <span class="n">fpKn1</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">blci1</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>  <span class="c1"># over all current superstates</span>
                <span class="c1"># finds to which states are the states in blci1 connected</span>
                <span class="c1"># through Fp_K.</span>
                <span class="n">blc_inds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">blci1</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>  <span class="c1"># over all components of the current superstate k</span>
                    <span class="n">blc_inds</span> <span class="o">+=</span> <span class="p">[</span><span class="n">blci</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
                                 <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Fp_K</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
                <span class="n">blc_inds</span> <span class="o">=</span> <span class="n">funique</span><span class="p">(</span><span class="n">blc_inds</span><span class="p">)</span>
                <span class="n">blc_inds</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="c1"># print &#39;Superstate &#39;, k, &#39;is connected to superstates&#39;,</span>
                <span class="c1"># blc_inds, &#39;for ib=&#39;, ib, &#39;and ik=&#39;, ik</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">blc_inds</span><span class="p">:</span>  <span class="c1"># over all components of superstate in sector N+1</span>
                    <span class="k">if</span> <span class="n">PRINT</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;F^+[ib=&#39;</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="s1">&#39;ik=&#39;</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="s1">&#39;] connects superstates &#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;with superstate&#39;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
                              <span class="s1">&#39;which are composed of the following basis states&#39;</span><span class="p">,</span> <span class="n">blci1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">blci1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;, respectively&#39;</span><span class="p">)</span>
                    <span class="n">Fpm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">blci1</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">blci1</span><span class="p">[</span><span class="n">j</span><span class="p">])),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blci1</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="n">j2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blci1</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">j2</span> <span class="ow">in</span> <span class="n">Fp_K</span><span class="p">[</span><span class="n">j1</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">]:</span>
                                <span class="n">Fpm</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fp_K</span><span class="p">[</span><span class="n">j1</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">j2</span><span class="p">]</span>
                    <span class="n">Fpm_new</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Tr</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Fpm</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Tr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">PRINT</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Fpm_old=&#39;</span><span class="p">,</span> <span class="n">Fpm</span><span class="p">)</span>
                        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Fpm_new=&#39;</span><span class="p">,</span> <span class="n">Fpm_new</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blci1</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="n">j2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blci1</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Fpm_new</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">wsmall</span><span class="p">):</span>
                                <span class="n">fpKn1</span><span class="p">[</span><span class="n">j1</span><span class="p">][</span><span class="n">j2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fpm_new</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">]</span>
            <span class="n">fpKn2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpKn1</span><span class="p">)</span>
        <span class="n">Fp_Knew</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpKn2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Fp_Knew</span>


<span class="k">def</span> <span class="nf">CreateFinalSuperstatesAndIndeces</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">wsmall</span><span class="p">,</span> <span class="n">PRINT</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates superstates from the form of F^+ in eigenbasis.</span>
<span class="sd">       It also creates indeces to these superstates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wblc_ind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">wblci</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">))]</span>
    <span class="n">wblci</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">wblci1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

    <span class="n">pseudo</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">all_pseudo</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_pseudo</span> <span class="o">+=</span> <span class="n">pseudo</span>
    <span class="c1"># We will do the same operation (of superstate creation) as above,</span>
    <span class="c1"># but this time we have F^+ in eigenbase.</span>
    <span class="c1"># We again start with all states at valence N-1, and from them we generate</span>
    <span class="c1"># states with valence N. We generate by applying F_k^+ to state at N-1.</span>
    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Nb0</span><span class="p">):</span>
        <span class="n">pseudon</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pse</span> <span class="ow">in</span> <span class="n">pseudo</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">block</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pse</span><span class="p">:</span>
                        <span class="n">nblck</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Fp_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="c1"># Instead of block += nblck</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nblck</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Fp_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">ii</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">wsmall</span><span class="p">:</span>
                                <span class="n">block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
                        <span class="c1"># create a set such that we can take union and</span>
                        <span class="c1"># intersection.</span>
                        <span class="n">block</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                        <span class="n">saved</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudon</span><span class="p">:</span>  <span class="c1"># over all current superstates at this occupancy</span>
                            <span class="k">if</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="n">block</span><span class="p">:</span>  <span class="c1"># does this superstate contain parts of the block</span>
                                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">|</span> <span class="n">block</span>  <span class="c1"># than we need to take a union</span>
                                <span class="n">saved</span> <span class="o">=</span> <span class="bp">True</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">saved</span><span class="p">:</span>     <span class="c1"># if it is entirely different superstate</span>
                            <span class="c1"># we just save it in entirety</span>
                            <span class="n">pseudon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

                        <span class="c1"># print &#39;ll=&#39;, ll, &#39;pse=&#39;, pse, &#39;ib,ik=&#39;, 2*ib+ik,</span>
                        <span class="c1"># &#39;block=&#39;, block, pseudon</span>

        <span class="n">pseudo</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudon</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pseudo</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">all_pseudo</span> <span class="o">+=</span> <span class="n">pseudo</span>

        <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">pseudo</span><span class="p">:</span>
            <span class="n">wblc_ind</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">wblci1</span><span class="p">[</span><span class="n">wblc_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps</span>
            <span class="c1"># print &#39;ind=&#39;, wblc_ind, &#39;ps=&#39;, ps</span>
            <span class="n">wblc_inside</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">:</span>
                <span class="n">wblci</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">wblc_ind</span><span class="p">,</span> <span class="n">wblc_inside</span><span class="p">)</span>
                <span class="n">wblc_inside</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">PRINT</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;wblci=&#39;</span><span class="p">,</span> <span class="n">wblci</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;wblci1=&#39;</span><span class="p">,</span> <span class="n">wblci1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">all_pseudo</span><span class="p">,</span> <span class="n">wblci</span><span class="p">,</span> <span class="n">wblci1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">CreateIndexFi2</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">wblci</span><span class="p">,</span> <span class="n">wsmall</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;We create also an index table Fi2 from Fp_Knew,</span>
<span class="sd">       which is convenient for printing of cix file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Fi2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">),</span> <span class="n">Nb0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">ifin</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">fis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Fp_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">ifin</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Fp_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Fp_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">ip</span><span class="p">][</span><span class="n">t</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">wsmall</span><span class="p">:</span>
                            <span class="n">ifin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wblci</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">ifin</span> <span class="o">=</span> <span class="n">funique</span><span class="p">(</span><span class="n">ifin</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Not unique superstate F^+&#39;</span><span class="p">,</span>
                          <span class="n">ifin</span><span class="p">,</span> <span class="s1">&#39;ib,ik=&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ib</span> <span class="o">+</span> <span class="n">ik</span><span class="p">,</span> <span class="s1">&#39;p=&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ifin</span><span class="p">:</span>
                    <span class="n">Fi2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Fi2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">Fi2</span>


<span class="k">def</span> <span class="nf">FindMaxsize</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">,</span> <span class="n">PRINT</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">maxsize</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxsize</span><span class="p">:</span>
            <span class="n">maxsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">PRINT</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;maxsize=&#39;</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">maxsize</span>


<span class="k">def</span> <span class="nf">Print_Fp_old_Fp_New</span><span class="p">(</span><span class="n">Fp_K</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
    <span class="s2">&quot;Printing Fp in two-site basis and in eigenbasis&quot;</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;old_f^+&#39;</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">Fp_K</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;f^+&#39;</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">CheckNKSconsistency</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">):</span>
    <span class="s2">&quot; Just checking NKS consistency &quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">):</span>
        <span class="n">pn</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="c1"># Since we always mixed states with the same N,K,Sz, we can just take</span>
        <span class="c1"># this from superstate</span>
        <span class="n">NKS</span> <span class="o">=</span> <span class="n">baseNKS</span><span class="p">[</span><span class="n">pn</span><span class="o">.</span><span class="n">pop</span><span class="p">()][:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pn</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">baseNKS</span><span class="p">[</span><span class="n">j</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NKS</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Combining states which do not have the same NKS!&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ERROR:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">baseNKS</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">p</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">PrintHeader</span><span class="p">(</span><span class="n">lcix</span><span class="p">,</span> <span class="n">bathk_ind</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Fi2</span><span class="p">,</span> <span class="n">Fj2</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">SUPERC</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">WithIndex</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="s2">&quot;Prints header only&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">):</span>
        <span class="c1"># Since we always mixed states with the same N,K,Sz, we can just take</span>
        <span class="c1"># this from superstate</span>
        <span class="n">NKS</span> <span class="o">=</span> <span class="n">baseNKS</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]][:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">Energ</span> <span class="o">=</span> <span class="p">[</span><span class="n">Energy</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">WithIndex</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%2d</span><span class="s2"> </span><span class="si">%2d</span><span class="s2"> </span><span class="si">%4.1f</span><span class="s2"> </span><span class="si">%2d</span><span class="s2"> &quot;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">NKS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">NKS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">NKS</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">SUPERC</span><span class="p">):</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span> <span class="ow">in</span> <span class="n">bathk_ind</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ib</span> <span class="o">&lt;</span> <span class="n">Nb0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Fi2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Fj2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span> <span class="ow">in</span> <span class="n">bathk_ind</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Fi2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="n">Energ</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
            <span class="k">print</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">PrintOneMatrixElement</span><span class="p">(</span><span class="n">lcix</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">Fi2</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">wblci</span><span class="p">):</span>
    <span class="n">ifinal</span> <span class="o">=</span> <span class="n">Fi2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> </span><span class="si">%3d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ifinal</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="n">Mw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ifinal</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">all_pseudo</span><span class="p">[</span><span class="n">ifinal</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%2d</span><span class="s2"> </span><span class="si">%2d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>

        <span class="n">Fp</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Fp_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">wblci</span><span class="p">[</span><span class="n">iq</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ifinal</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ERROR in ifinal!&#39;</span><span class="p">)</span>
                <span class="n">jj</span> <span class="o">=</span> <span class="n">wblci</span><span class="p">[</span><span class="n">iq</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Fp</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fp_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">ip</span><span class="p">][</span><span class="n">iq</span><span class="p">]</span>

        <span class="n">Mw</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">Fp</span><span class="p">,</span> <span class="n">transpose</span><span class="p">(</span><span class="n">Fp</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">Fp</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%2d</span><span class="s2"> </span><span class="si">%2d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Mw</span>


<span class="k">def</span> <span class="nf">PrintMatrixElements</span><span class="p">(</span><span class="n">lcix</span><span class="p">,</span> <span class="n">bathk_ind</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Fi2</span><span class="p">,</span> <span class="n">Fj2</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">Fm_Knew</span><span class="p">,</span> <span class="n">wblci</span><span class="p">,</span> <span class="n">SUPERC</span><span class="p">):</span>
    <span class="s2">&quot;Prints matrix elements for F^dagger operator&quot;</span>
    <span class="n">Nocc</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># occupancy</span>
    <span class="k">for</span> <span class="n">ibk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bathk_ind</span><span class="p">)):</span>
        <span class="n">Nocc</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">list</span><span class="p">([])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">))])</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ibk</span><span class="p">,</span> <span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bathk_ind</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">SUPERC</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ib</span> <span class="o">&lt;</span> <span class="n">Nb0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="n">Mw</span> <span class="o">=</span> <span class="n">PrintOneMatrixElement</span><span class="p">(</span>
                        <span class="n">lcix</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">Fi2</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">wblci</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Mw</span> <span class="o">=</span> <span class="n">PrintOneMatrixElement</span><span class="p">(</span>
                        <span class="n">lcix</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">Fj2</span><span class="p">,</span> <span class="n">Fm_Knew</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">wblci</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Mw</span> <span class="o">=</span> <span class="n">PrintOneMatrixElement</span><span class="p">(</span>
                    <span class="n">lcix</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">Fi2</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">wblci</span><span class="p">)</span>
            <span class="n">Nocc</span><span class="p">[</span><span class="n">ibk</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">identity</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">-</span> <span class="n">Mw</span>
    <span class="k">return</span> <span class="n">Nocc</span>


<span class="k">def</span> <span class="nf">PrintOccupancy</span><span class="p">(</span><span class="n">lcix</span><span class="p">,</span> <span class="n">bathk_ind</span><span class="p">,</span> <span class="n">Nocc</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">baths</span><span class="p">):</span>

    <span class="n">cases</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ik</span> <span class="k">for</span> <span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span> <span class="ow">in</span> <span class="n">bathk_ind</span><span class="p">])</span>
    <span class="n">Nineq</span> <span class="o">=</span> <span class="n">cases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">bequal</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">([])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nineq</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">ibk</span><span class="p">,</span> <span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bathk_ind</span><span class="p">):</span>
        <span class="n">bequal</span><span class="p">[</span><span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ibk</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">ib</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bequal</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%2d</span><span class="s2"> </span><span class="si">%2d</span><span class="s2"> </span><span class="si">%2d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>

            <span class="n">nocc</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ibk</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>  <span class="c1"># sum over equivalent</span>
                <span class="n">nocc</span> <span class="o">+=</span> <span class="n">Nocc</span><span class="p">[</span><span class="n">ibk</span><span class="p">][</span><span class="n">i</span><span class="p">][:,</span> <span class="p">:]</span>

            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%10.6f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">nocc</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">PrintCixFile</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">bathk_ind</span><span class="p">,</span> <span class="n">Fi2</span><span class="p">,</span> <span class="n">Fj2</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">Fm_Knew</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">baths</span><span class="p">,</span> <span class="n">epsk2q</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">wblci</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">,</span> <span class="n">SUPERC</span><span class="p">):</span>
    <span class="s2">&quot;Printing Cix file&quot;</span>
    <span class="n">lcix</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# CIX file for ctqmc! &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# cluster_size, number of states, number of baths, maximum_matrix_size&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">SUPERC</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bathk_ind</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# baths, dimension, symmetry&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>

        <span class="n">sc_bath</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># combine spin up and down into one entry</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bathk_ind</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">sc_bath</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">bathk_ind</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span> <span class="n">bathk_ind</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>

        <span class="c1"># off-diagonal elements will come at the very end</span>
        <span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">bathk_ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lastb_ind</span> <span class="o">=</span> <span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sc_bath</span><span class="p">)):</span>
            <span class="n">ib1</span> <span class="o">=</span> <span class="n">sc_bath</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># spin-up</span>
            <span class="n">ib2</span> <span class="o">=</span> <span class="n">sc_bath</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># spin-dn</span>
            <span class="n">ik</span> <span class="o">=</span> <span class="n">sc_bath</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># k is either 0 or pi</span>
            <span class="c1"># print &#39;ib=&#39;, ib1, &#39;ib2=&#39;, ib2, &#39;ik=&#39;, ik, &#39;cc=&#39;,</span>
            <span class="c1"># baths[ib1][1]*2+ik, baths[ib2][1]*2+ik,</span>
            <span class="c1"># index, dimension</span>
            <span class="k">print</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%-2d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">),</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">]</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ik</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># select symmetry for for s+-</span>
                <span class="n">off_index</span> <span class="o">=</span> <span class="n">lastb_ind</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">off_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">lastb_ind</span>
                <span class="n">lastb_ind</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span><span class="p">(</span><span class="n">baths</span><span class="p">[</span><span class="n">ib1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ik</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%2d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">off_index</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%2d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">off_index</span><span class="p">),</span>
                  <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="n">baths</span><span class="p">[</span><span class="n">ib2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ik</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
            <span class="c1"># print &gt;&gt; lcix, baths[ib1][2]*2+ik, &#39;  # ik=&#39;, ik  # symmetry</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bathk_ind</span><span class="p">),</span> <span class="n">maxsize</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# baths, dimension, symmetry&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bathk_ind</span><span class="p">):</span>
            <span class="k">print</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%-2d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">),</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ik</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">baths</span><span class="p">[</span>
                  <span class="n">ib</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ik</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>  <span class="c1"># , &#39;# ib=&#39;, ib, &#39;ik=&#39;, ik</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# cluster energies for non-equivalent baths, eps[k]&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">epsk2q</span><span class="p">)):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">epsk2q</span><span class="p">[</span><span class="n">ib</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SUPERC</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sc_bath</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;#     N  K  Sz size&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>

    <span class="n">PrintHeader</span><span class="p">(</span><span class="n">lcix</span><span class="p">,</span> <span class="n">bathk_ind</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span>
                <span class="n">Fi2</span><span class="p">,</span> <span class="n">Fj2</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">SUPERC</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# matrix elements&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="n">Nocc</span> <span class="o">=</span> <span class="n">PrintMatrixElements</span><span class="p">(</span>
        <span class="n">lcix</span><span class="p">,</span> <span class="n">bathk_ind</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Fi2</span><span class="p">,</span> <span class="n">Fj2</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">Fm_Knew</span><span class="p">,</span> <span class="n">wblci</span><span class="p">,</span> <span class="n">SUPERC</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;HB1&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# number of operators needed&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# Occupancy &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="n">PrintOccupancy</span><span class="p">(</span><span class="n">lcix</span><span class="p">,</span> <span class="n">bathk_ind</span><span class="p">,</span> <span class="n">Nocc</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">baths</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# Data for HB1&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">SUPERC</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bathk_ind</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#print &gt;&gt; lcix, 2, len(all_pseudo), Nb0*2, maxsize</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bathk_ind</span><span class="p">),</span> <span class="n">maxsize</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;#      ind N  K  Sz  size&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>

    <span class="n">PrintHeader</span><span class="p">(</span><span class="n">lcix</span><span class="p">,</span> <span class="n">bathk_ind</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Fi2</span><span class="p">,</span>
                <span class="n">Fj2</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">SUPERC</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# matrix elements&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">lcix</span><span class="p">)</span>
    <span class="n">PrintMatrixElements</span><span class="p">(</span><span class="n">lcix</span><span class="p">,</span> <span class="n">bathk_ind</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span>
                        <span class="n">Fi2</span><span class="p">,</span> <span class="n">Fj2</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">Fm_Knew</span><span class="p">,</span> <span class="n">wblci</span><span class="p">,</span> <span class="n">SUPERC</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Test_FpF_Expensive</span><span class="p">(</span><span class="n">Nb0</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
    <span class="c1"># f_a^+ f_a + f_a f_a^+ = 1</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">Fpt</span> <span class="o">=</span> <span class="n">Fp_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span>
            <span class="n">Fd</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)):</span>
                <span class="n">wp</span> <span class="o">=</span> <span class="n">Fpt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">wp</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">Fd</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">wp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

            <span class="n">Fd</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Fd</span><span class="p">)</span>
            <span class="n">ID</span> <span class="o">=</span> <span class="n">Fd</span> <span class="o">*</span> <span class="n">Fd</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Fd</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">Fd</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;abs(1-F^+F+FF^+)&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ID</span> <span class="o">-</span> <span class="n">identity</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)))))</span>


<span class="k">def</span> <span class="nf">CheckIndexFi</span><span class="p">(</span><span class="n">Fi2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">Fi2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">fi</span> <span class="o">=</span> <span class="n">Fi2</span><span class="p">[:,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">while</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">fi</span><span class="p">:</span>
                <span class="n">fi</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fi</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fi</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fi</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Pseudo&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
                      <span class="s1">&#39;appears multiple times for ib=&#39;</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="s1">&#39;and ik=&#39;</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Transpose_Fp</span><span class="p">(</span><span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">wblci</span><span class="p">,</span> <span class="n">wsmall</span><span class="p">):</span>
    <span class="s2">&quot;Transposes F^\dagger to obtain F!&quot;</span>
    <span class="n">Fm_Knew</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
        <span class="n">fm2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">fm</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Fp_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">]))]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Fp_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="c1"># print &#39;ip=&#39;, ip, &#39;iq=&#39;, iq, &#39;fp=&#39;, Fp_Knew[ib][ik][ip][iq]</span>
                        <span class="c1"># print &#39;len(fm)=&#39;, len(fm)</span>
                        <span class="n">fm</span><span class="p">[</span><span class="n">iq</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fp_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">ip</span><span class="p">][</span><span class="n">iq</span><span class="p">]</span>

            <span class="n">fm2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span>
        <span class="n">Fm_Knew</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fm2</span><span class="p">)</span>

    <span class="n">Fj2</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">),</span> <span class="n">Nb0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">ifin</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">fis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Fm_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">ifin</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Fm_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Fm_Knew</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="n">ik</span><span class="p">][</span><span class="n">ip</span><span class="p">][</span><span class="n">t</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">wsmall</span><span class="p">:</span>
                            <span class="n">ifin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wblci</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">ifin</span> <span class="o">=</span> <span class="n">funique</span><span class="p">(</span><span class="n">ifin</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Not unique superstate F^+&#39;</span><span class="p">,</span>
                          <span class="n">ifin</span><span class="p">,</span> <span class="s1">&#39;ib,ik=&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ib</span> <span class="o">+</span> <span class="n">ik</span><span class="p">,</span> <span class="s1">&#39;p=&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ifin</span><span class="p">:</span>
                    <span class="n">Fj2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Fj2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">Fm_Knew</span><span class="p">,</span> <span class="n">Fj2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">PrintSingleSiteCixFile</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">Uc</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Nm0</span><span class="p">,</span> <span class="n">baths</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">mN</span><span class="p">,</span> <span class="n">mSz</span><span class="p">,</span> <span class="n">msize</span><span class="p">,</span> <span class="n">mEne</span><span class="p">,</span> <span class="n">mS2</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Fm</span><span class="p">,</span> <span class="n">Ek</span><span class="p">):</span>
    <span class="s2">&quot;Writing single-site cix file&quot;</span>

    <span class="k">def</span> <span class="nf">PrintHeader</span><span class="p">(</span><span class="n">WithIndex</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># print &#39;Fi=&#39;, Fi</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns0</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">WithIndex</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%2d</span><span class="s2"> </span><span class="si">%2d</span><span class="s2"> </span><span class="si">%4.1f</span><span class="s2"> </span><span class="si">%2d</span><span class="s2"> &quot;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">mN</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mSz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">msize</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Fi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">msize</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">mEne</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">msize</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">mS2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">PrintMatrixElm</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns0</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">Fi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ib</span><span class="p">]</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> </span><span class="si">%3d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%2d</span><span class="s2"> </span><span class="si">%2d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msize</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">msize</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">im1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">msize</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">im2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">msize</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                            <span class="k">print</span><span class="p">(</span><span class="n">Fm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ib</span><span class="p">][</span><span class="n">im1</span><span class="p">,</span> <span class="n">im2</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%2d</span><span class="s2"> </span><span class="si">%2d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

    <span class="n">Ns0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mN</span><span class="p">)</span>
    <span class="c1"># Lets correct onsite energies with Ek</span>
    <span class="n">Ek_local</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ek</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Ek</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">)]</span>  <span class="c1"># from input Ek</span>
    <span class="c1"># Ek_local_orig = [eps[baths[i][1]] for i in range(Nb0)]  # from origonal</span>
    <span class="c1"># SS-cix file</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;##Ek_local     =&#39;</span><span class="p">,</span> <span class="n">Ek_local</span><span class="p">)</span>
    <span class="c1"># print &#39;##Ek_local_orig=&#39;, Ek_local_orig</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;##eps=&#39;</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;##baths=&#39;</span><span class="p">,</span> <span class="n">baths</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;##degi=&#39;</span><span class="p">,</span> <span class="n">baths</span><span class="p">)</span>

    <span class="c1"># correcting eps with Ek</span>
    <span class="n">eps_local</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">degi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
        <span class="n">eps_local</span><span class="p">[</span><span class="n">baths</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">Ek_local</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">degi</span><span class="p">[</span><span class="n">baths</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">eps_local</span> <span class="o">=</span> <span class="p">[</span><span class="n">eps_local</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">degi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eps</span><span class="p">))]</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;##eps_local=&#39;</span><span class="p">,</span> <span class="n">eps_local</span><span class="p">)</span>

    <span class="c1"># Adding Coulomb term U to on-site energies</span>
    <span class="c1">###mE = [mEne[i] + Uc*mN[i]*(mN[i]-1)/2. for i in range(len(mEne))]</span>

    <span class="c1"># print &#39;Ek_local=&#39;, Ek_local</span>

    <span class="c1"># for ib in range(Nb0):</span>
    <span class="c1">###    R = [array([0]) for i in range(Ns0)]</span>
    <span class="c1"># for i in range(Ns0):</span>
    <span class="c1">###        j = Fi[i,ib]</span>
    <span class="c1"># if (j&gt;=0):</span>
    <span class="c1">###            r = zeros(msize[j],dtype=float)</span>
    <span class="c1"># for im1 in range(msize[i]):</span>
    <span class="c1"># for im2 in range(msize[j]):</span>
    <span class="c1">###                    r[im2] += Fm[i][ib][im1,im2]**2</span>
    <span class="c1"># R[j]=r</span>
    <span class="c1"># for i in range(Ns0): Nt[i] += R[i]</span>
    <span class="c1"># for i in range(len(R)):</span>
    <span class="c1">###        mE[i] += R[i]*(Ek_local[ib]-Ek_local_orig[ib])</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# CIX file for ctqmc!&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# cluster_size, number of states, number of baths, maximum_matrix_size&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Ns0</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Nm0</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# baths, dimension, symmetry&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# cluster energies for non-equivalent baths, eps[k]&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eps</span><span class="p">)):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">Ek_local</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# N   K   Sz size&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

    <span class="n">PrintHeader</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# matrix elements&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="n">PrintMatrixElm</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;HB1&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# number of operators needed&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# Data for HB1&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Ns0</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Nm0</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# ind   N   K   Jz size&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="n">PrintHeader</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;# matrix elements&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="n">PrintMatrixElm</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">Uc</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">Ek0</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">wsmall</span><span class="p">,</span> <span class="n">ssc</span><span class="p">,</span> <span class="n">SUPERC</span><span class="p">):</span>

    <span class="c1">#################################</span>
    <span class="c1"># Reading the one-site cix file #</span>
    <span class="c1">#################################</span>
    <span class="p">(</span><span class="n">Nc0</span><span class="p">,</span> <span class="n">Ns0</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Nm0</span><span class="p">,</span> <span class="n">baths</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">mN</span><span class="p">,</span> <span class="n">mSz</span><span class="p">,</span> <span class="n">msize</span><span class="p">,</span>
     <span class="n">mEne</span><span class="p">,</span> <span class="n">mS2</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Fm</span><span class="p">)</span> <span class="o">=</span> <span class="n">ReadOneSiteCix</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

    <span class="c1"># building Ek for each k-orbital-and-spin</span>
    <span class="n">Ek</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">Ek</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ib</span> <span class="o">+</span> <span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ek0</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">baths</span><span class="p">[</span><span class="n">ib</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ik</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;##Ek0=&#39;</span><span class="p">,</span> <span class="n">Ek0</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;##Ek=&#39;</span><span class="p">,</span> <span class="n">Ek</span><span class="p">)</span>

    <span class="c1">###########################################</span>
    <span class="c1"># removing baths which have energy &gt; 1000 #</span>
    <span class="c1">###########################################</span>
    <span class="p">(</span><span class="n">Nb0</span><span class="p">,</span> <span class="n">baths</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">Ek</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Fm</span><span class="p">)</span> <span class="o">=</span> <span class="n">RemoveBaths</span><span class="p">(</span>
        <span class="n">Nb0</span><span class="p">,</span> <span class="n">Ns0</span><span class="p">,</span> <span class="n">baths</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">Ek</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Fm</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;##Ek=&#39;</span><span class="p">,</span> <span class="n">Ek</span><span class="p">)</span>

    <span class="n">mEne</span> <span class="o">=</span> <span class="n">CorrectSingleSiteEnergies</span><span class="p">(</span>
        <span class="n">Ns0</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">msize</span><span class="p">,</span> <span class="n">mN</span><span class="p">,</span> <span class="n">mEne</span><span class="p">,</span> <span class="n">baths</span><span class="p">,</span> <span class="n">Uc</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">Ek</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Fm</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">110</span><span class="p">)</span>

    <span class="n">PrintSingleSiteCixFile</span><span class="p">(</span><span class="n">ssc</span><span class="p">,</span> <span class="n">Uc</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Nm0</span><span class="p">,</span> <span class="n">baths</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span>
                           <span class="n">mN</span><span class="p">,</span> <span class="n">mSz</span><span class="p">,</span> <span class="n">msize</span><span class="p">,</span> <span class="n">mEne</span><span class="p">,</span> <span class="n">mS2</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Fm</span><span class="p">,</span> <span class="n">Ek</span><span class="p">)</span>

    <span class="c1">#############################</span>
    <span class="c1"># Adding the Coulomb U term #</span>
    <span class="c1">#############################</span>
    <span class="n">epsk2q</span> <span class="o">=</span> <span class="n">Ek0</span>

    <span class="c1"># print &#39;##mEne=&#39;, mEne</span>

    <span class="c1">###########################</span>
    <span class="c1"># Creates two-site basis  #</span>
    <span class="c1">###########################</span>
    <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">,</span> <span class="n">pairs</span><span class="p">)</span> <span class="o">=</span> <span class="n">Create2SiteBasis</span><span class="p">(</span>
        <span class="n">Ns0</span><span class="p">,</span> <span class="n">mN</span><span class="p">,</span> <span class="n">mSz</span><span class="p">,</span> <span class="n">mEne</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>

    <span class="c1">#############################################</span>
    <span class="c1"># Creates matrix elements of creation and   #</span>
    <span class="c1"># anhilation operator in the two-site basis #</span>
    <span class="c1">#############################################</span>
    <span class="p">(</span><span class="n">Fp_K</span><span class="p">,</span> <span class="n">Fm_K</span><span class="p">)</span> <span class="o">=</span> <span class="n">ComputeFdag</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">mN</span><span class="p">,</span> <span class="n">Fi</span><span class="p">,</span> <span class="n">Fm</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">)</span>

    <span class="c1">#########################################</span>
    <span class="c1"># Here we compute all_NN = F^dagger*F   #</span>
    <span class="c1"># We also compute F*F^dagger, and we    #</span>
    <span class="c1"># can check if F^dagger*F+F*F^dagger=1  #</span>
    <span class="c1">#########################################</span>
    <span class="n">all_NN</span> <span class="o">=</span> <span class="n">ComputeOccup</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Fp_K</span><span class="p">,</span> <span class="n">Fm_K</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Here we generate all superstates (pseudo) and index tables from original basis #</span>
    <span class="c1"># to this new basis. We also diagonalize the two-site problem and save           #</span>
    <span class="c1"># eigenvalues (Eham) and eigenvectors(Tr)                                        #</span>
    <span class="c1">##########################################################################</span>
    <span class="p">(</span><span class="n">pseudo</span><span class="p">,</span> <span class="n">blci</span><span class="p">,</span> <span class="n">blci1</span><span class="p">,</span> <span class="n">Tr</span><span class="p">,</span> <span class="n">Eham</span><span class="p">,</span> <span class="n">Energy</span><span class="p">)</span> <span class="o">=</span> <span class="n">CreateDiagPseudos</span><span class="p">(</span>
        <span class="n">Nb0</span><span class="p">,</span> <span class="n">Fp_K</span><span class="p">,</span> <span class="n">all_NN</span><span class="p">,</span> <span class="n">Ek</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">,</span> <span class="n">wsmall</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">130</span><span class="p">)</span>

    <span class="c1">####################################################################</span>
    <span class="c1"># Here we transform creation operator F to the two-side eigenbasis #</span>
    <span class="c1">####################################################################</span>
    <span class="n">Fp_Knew</span> <span class="o">=</span> <span class="n">Transform_F_To_Eigensybase</span><span class="p">(</span>
        <span class="n">Fp_K</span><span class="p">,</span> <span class="n">Tr</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">blci</span><span class="p">,</span> <span class="n">blci1</span><span class="p">,</span> <span class="n">wsmall</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="c1">#########################</span>
    <span class="c1"># Just printing of F^+  #</span>
    <span class="c1">#########################</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">140</span><span class="p">:</span>
        <span class="n">Print_Fp_old_Fp_New</span><span class="p">(</span><span class="n">Fp_K</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>

    <span class="c1">######################################################################</span>
    <span class="c1"># We generate new superstates based on the form of F^+ in eigenbasis #</span>
    <span class="c1"># We also generate indeces to these superstates                      #</span>
    <span class="c1">######################################################################</span>
    <span class="p">(</span><span class="n">all_pseudo</span><span class="p">,</span> <span class="n">wblci</span><span class="p">,</span> <span class="n">wblci1</span><span class="p">)</span> <span class="o">=</span> <span class="n">CreateFinalSuperstatesAndIndeces</span><span class="p">(</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">wsmall</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">)</span>

    <span class="c1">#########################</span>
    <span class="c1"># Just checking baseNKS #</span>
    <span class="c1">#########################</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="n">CheckNKSconsistency</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">)</span>

    <span class="c1">##################################################</span>
    <span class="c1"># Index table Fi for fast rejection of QMC steps #</span>
    <span class="c1"># is constructed from Fp_Knew                    #</span>
    <span class="c1">##################################################</span>
    <span class="n">Fi2</span> <span class="o">=</span> <span class="n">CreateIndexFi2</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">wblci</span><span class="p">,</span> <span class="n">wsmall</span><span class="p">)</span>

    <span class="n">CheckIndexFi</span><span class="p">(</span><span class="n">Fi2</span><span class="p">)</span>

    <span class="c1">###############################</span>
    <span class="c1"># We need maximum matrix size #</span>
    <span class="c1">#   for printing              #</span>
    <span class="c1">###############################</span>
    <span class="n">maxsize</span> <span class="o">=</span> <span class="n">FindMaxsize</span><span class="p">(</span><span class="n">all_pseudo</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">)</span>

    <span class="p">(</span><span class="n">Fm_Knew</span><span class="p">,</span> <span class="n">Fj2</span><span class="p">)</span> <span class="o">=</span> <span class="n">Transpose_Fp</span><span class="p">(</span><span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">wblci</span><span class="p">,</span> <span class="n">wsmall</span><span class="p">)</span>

    <span class="n">bathk_ind</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">NEW</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">NEW</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">bathk_ind</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>          <span class="c1"># spin-up,k=0</span>
            <span class="n">bathk_ind</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Nb0</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>    <span class="c1"># spin-dn,k=0</span>
            <span class="n">bathk_ind</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>          <span class="c1"># spin-up,k=pi</span>
            <span class="n">bathk_ind</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Nb0</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>    <span class="c1"># spin-dn,k=pi</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nb0</span><span class="p">):</span>
            <span class="n">bathk_ind</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">bathk_ind</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1">#######################################################################</span>
    <span class="c1">#               Below is printing for ctqmc  solver                   #</span>
    <span class="c1">#######################################################################</span>
    <span class="n">PrintCixFile</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">bathk_ind</span><span class="p">,</span> <span class="n">Fi2</span><span class="p">,</span> <span class="n">Fj2</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">Fm_Knew</span><span class="p">,</span> <span class="n">all_pseudo</span><span class="p">,</span>
                 <span class="n">baths</span><span class="p">,</span> <span class="n">epsk2q</span><span class="p">,</span> <span class="n">baseNKS</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">wblci</span><span class="p">,</span> <span class="n">Nb0</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">,</span> <span class="n">SUPERC</span><span class="p">)</span>
    <span class="c1">#PrintCixFile(outfile, Fj2, Fm_Knew, all_pseudo, baths, epsk2q, baseNKS, Energy, wblci, Nb0, maxsize)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">3000</span><span class="p">:</span>
        <span class="n">Test_FpF_Expensive</span><span class="p">(</span><span class="n">Nb0</span><span class="p">,</span> <span class="n">Fp_Knew</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an input cix file for a single-site DMFT (limited to ising case for the moment)</span>
<span class="sd">    creates cix file for two site CDMFT.</span>

<span class="sd">    If SUPERC=True, it creates input file for s+- superconductivity</span>

<span class="sd">    It is important to specify the on-site coulomb repulsion Uc,</span>
<span class="sd">    and the non-local part of the impurity levels Ek.</span>

<span class="sd">    For Ek, the order in the 5 band model is the following:</span>
<span class="sd">     Ek[0]=E_{x^2-y^2,k=0}</span>
<span class="sd">     Ek[1]=E_{x^2-y^2,k=pi}</span>
<span class="sd">     Ek[2]=E_{z^2,k=0}</span>
<span class="sd">     Ek[3]=E_{z^2,k=pi}</span>
<span class="sd">     Ek[4]=E_{xz,k=0}</span>
<span class="sd">     Ek[5]=E_{xz,k=pi}</span>
<span class="sd">     Ek[6]=E_{yz,k=0}</span>
<span class="sd">     Ek[7]=E_{yz,k=pi}</span>
<span class="sd">     Ek[8]=E_{xy,k=0}</span>
<span class="sd">     Ek[9]=E_{xy,k=pi}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">usage</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;usage: %prog [ options ]</span>

<span class="s2">    Given an input cix file for a single-site DMFT (limited to ising case for the moment)</span>
<span class="s2">    creates cix file for two site CDMFT.</span>

<span class="s2">    If SUPERC=True, it creates input file for s+- superconductivity</span>

<span class="s2">    It is important to specify the on-site coulomb repulsion Uc,</span>
<span class="s2">    and the non-local part of the impurity levels Ek.</span>

<span class="s2">    Ek should be in the followin format: Ek=[E1_{k=0},E1_{k=pi},E2_{k=0},E2_{k=pi},....]</span>

<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-E&quot;</span><span class="p">,</span> <span class="s2">&quot;--Ek&quot;</span><span class="p">,</span>  <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;Ek&quot;</span><span class="p">,</span>  <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="s2">&quot;[0,0,0,0,0]&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Impurity levels of the two site cluster Ek&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-U&quot;</span><span class="p">,</span> <span class="s2">&quot;--Uc&quot;</span><span class="p">,</span>  <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;Uc&quot;</span><span class="p">,</span>  <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;On-site Hubbard Coulomb repulsion U&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="s1">&#39;link_actqmc.cix&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;filename of the output 2-site cix file&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--inp&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;inp&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="s1">&#39;actqmc.cix&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;filename of the input single-site cix file&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--ssc&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;ssc&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;SS_actqmc.cix&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;filename of the intermediate single-site cix file&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-S&quot;</span><span class="p">,</span> <span class="s2">&quot;--SUPER&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;SUPER&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;cix file superconductivity&quot;</span><span class="p">)</span>
    <span class="c1"># Next, parse the arguments</span>
    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">Ek0</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">Ek</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Ek=&#39;</span><span class="p">,</span> <span class="n">Ek0</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;U=&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">Uc</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;inp=&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">inp</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;out=&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">out</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ssc=&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">ssc</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;super=&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">SUPER</span><span class="p">)</span>

    <span class="n">wsmall</span> <span class="o">=</span> <span class="mf">1e-10</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">100</span>       <span class="c1"># debug information</span>

    <span class="c1"># for three band model</span>
    <span class="c1">#  [ E_{xz,k=0}, E_{xz,k=pi}, E_{yz,k=0], E_{yz,k=pi}, E_{xy,k=0}, E_{xy,k=pi} ]</span>
    <span class="c1">#Ek0 = [0, 0, 0.1, 0.1, 0.00922, 0, 0, -0.1, -0.1, -0.00922]</span>
    <span class="c1"># Ek0=[-0.48224573,0.38333269,0.40048207,0.95556531,-0.00999893,-0.00469948]</span>
    <span class="c1">#Ek0=[-0.71890552,0.1466729, 0.16382228,0.71890552,-0.24665872,-0.24135927]</span>
    <span class="c1"># Ek0=[-0.71890552,0.71890552,0.1466729,-0.24665872,0.16382228,-0.24135927]</span>
    <span class="c1"># Ek0=[0.,1.4378107,0.86557738,0.47224477,0.88272563,0.47754649]</span>

    <span class="c1"># for one band model</span>
    <span class="c1"># Ek0 = [0.5,-0.5]  # Ek=[E_{K=0},E_{K=pi}]</span>
    <span class="c1">#infile = &#39;actqmc_one_band.cix&#39;</span>

    <span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">inp</span><span class="p">,</span> <span class="n">Ek0</span><span class="p">,</span>
         <span class="n">verbose</span><span class="p">,</span> <span class="n">wsmall</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">ssc</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">SUPER</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Total running time of the script:</strong> ( 0 minutes  0.000 seconds)</p>
<div class="sphx-glr-footer docutils container">
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../../_downloads/link.py" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">link.py</span></code></a></div>
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../../_downloads/link.ipynb" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">link.ipynb</span></code></a></div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.readthedocs.io">Generated by Sphinx-Gallery</a></p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/dimer_lattice/cthyb/link.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Learn DMFT 0.5.0-git documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014-2017, Ãscar NÃ¡jera.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.5.
    </div>
  </body>
</html>